<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styleAdmin.css') }}">
    {% if bookInfo %}
    <title>eBookReader(adm) - {{bookInfo['name']}} ({{bookInfo['volume']}})</title>
    <script>
        let bookInfo = {{ bookInfo | tojson }}
        let bookList = {{bookList | tojson}}
    </script>
    {% else %}
    <title>eBookReader(adm)</title>
    <script>
        let bookList = {{bookList | tojson}}
    </script>
    {% endif %}
</head>
<body>
    <script>
        // í´ë¦­ ì• ë‹ˆë©”ì´ì…˜ (ì´ì¤‘ í´ë¦­ ë°©ì§€)
        function imWorking(target){
            target.onclick = null
            target.innerText = 'ğŸŒ€'
            target.classList.add('working')
        }

        // ìˆ˜ì • ì·¨ì†Œì‹œ ìƒˆë¡œê³ ì¹¨
        function cancelChange(){
            if(!confirm("ìˆ˜ì •ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                return
            }
            window.location.href = window.location.href
        }

        // post ìš”ì²­í•˜ê¸°
        function postAPI(url, data){
            let form = document.createElement('form')
            form.method = 'post'
            form.action = url
            document.body.appendChild(form)
            for(let key in data){
                let dataInput = document.createElement('input')
                dataInput.name = key
                dataInput.value = data[key]
                form.appendChild(dataInput)
            }
            form.submit()
        }

        // ë„ì„œ ì¶”ê°€ ê´€ë ¨
        function insertBook(){
            
        }

        // ë„ì„œ ìˆ˜ì • ê´€ë ¨
        function changeBookInput(bookName){
            // contentë¥¼ inputìœ¼ë¡œ ë³€ê²½(a íƒœê·¸ ë¬´ë ¥í™”ë¥¼ ìœ„í•´ aíƒœê·¸ ìì²´ë¥¼ ë³€ê²½)
            let target = document.getElementById('boxbook' + bookName)
            let book = target.innerText
            let aTag = target.parentElement
            aTag.outerHTML = "<input id='boxbook" + bookName + "' value='" + book + "'/>"
            // ìˆ˜ì •ë²„íŠ¼ì˜ ê¸°ëŠ¥ ë³€ê²½
            let targetBtn = document.getElementById('modbook' + bookName)
            targetBtn.onclick = ()=>{changeBook(bookName)}
            targetBtn.innerText = 'âœ…'
            // Inputì— focus ë° keydown EventListener ì„¤ì •
            let targetInput = document.getElementById('boxbook' + bookName)
            targetInput.focus()
            var tempValue = '' // ì»¤ì„œë¥¼ ë§¨ ë’¤ë¡œ ë³´ë‚´ê¸° ìœ„í•œ ê³¼ì •
            tempValue = targetInput.value
            targetInput.value = ''
            targetInput.value = tempValue
            targetInput.addEventListener('keydown',(e)=>{
                if(e.key == 'Enter'){
                    changeBook(bookName)
                }else if(e.key == 'Escape'){
                    cancelChange()
                }
            })
            // X ë²„íŠ¼ì˜ ê¸°ëŠ¥ ë³€ê²½ (ì‚­ì œì—ì„œ ìˆ˜ì • ì·¨ì†Œë¡œ..)
            let targetDelBtn = document.getElementById('delbook' + bookName)
            targetDelBtn.onclick = ()=>{cancelChange()}
        }

        function changeBook(bookName){
            let targetBtn = document.getElementById('modbook' + bookName)
            imWorking(targetBtn)
            let book = document.getElementById('boxbook' + bookName).value
            let data = {
                'newBook' : book
            }
            let targetURL = "/update/" + bookName
            postAPI(targetURL, data)
        }

        // ë„ì„œ ì‚­ì œ ê´€ë ¨
        function deleteBook(bookName){
            if(!confirm('"' + bookName + '" ë„ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
                return
            }
            let targetBtn = document.getElementById('delbook' + bookName)
            imWorking(targetBtn)
            let targetURL = "/delete/" + bookName
            let data = {}
            postAPI(targetURL, data)
        }
    </script>
    <header id="header">
        <a href="/"><h2 id="headTitle">eBookReader(end Adm)</h2></a>
        {% if bookInfo %}
            <p>
                <span id="headName">{{bookInfo['name']}} </span>
                / <input id="headVolume" class="headInput" name="headValue" type="text" value="{{bookInfo['volume']}}" />ê¶Œ(í™”)
                / <input id="headLine" class="headInput" name="headLine" type="text" value="{{bookInfo['line']}}" />ì¤„
                <button id="headButton">ì´ë™</button>
            </p>
        {% endif %}
    </header>
    <sidebar id="sidebar">
        <ul>
            <li>- ì œëª©ìˆœ</li>
            {% for bookName in bookList %}
                <li id="li{{bookName}}" class="bookList">
                    <a href="/admin/{{bookName}}"><span id="boxbook{{bookName}}">{{bookName}}</span></a>
                    <span id="modbook{{bookName}}" onclick="changeBookInput('{{bookName}}')">âœï¸</span>
                    <span id="delbook{{bookName}}" onclick="deleteBook('{{bookName}}')">âŒ</span>
                </li>
            {% endfor %}
            <li id="insbook" class="volume">â•</li>
        </ul>
    </sidebar>
    <contents id="contents">
        {% block content %} {% endblock %}
    </contents>
    <footer id="footer">
        CkriT (ckrit3@gmail.com)
    </footer>
{% if bookInfo %}
    <script>
        // ì„ íƒí•œ ì±… í‘œì‹œ
        let bookList = document.getElementsByClassName('bookList')
        for(index in bookList){
            if(bookList[index].innerText == "{{bookInfo['name']}}"){
                bookList[index].style['color']='black'
                bookList[index].style['font-weight']='bold'
            }
        }
        
        // ìƒë‹¨ë°” ì´ë™
        function movePage(){
            if(volumeInput.value == "{{bookInfo['volume']}}"){
                moveLine(lineInput.value)
            }else{
                window.location.href = "/admin/{{bookInfo['name']}}/" + volumeInput.value + '/' + lineInput.value
            }
        }
        let volumeInput = document.getElementById('headVolume')
        let lineInput = document.getElementById('headLine')
        let moveBtn = document.getElementById('headButton')
        volumeInput.addEventListener('keydown',(e)=>{
            if(e.key == 'Enter'){
                movePage()
            }
        })
        lineInput.addEventListener('keydown',(e)=>{
            if(e.key == 'Enter'){
                movePage()
            }
        })
        moveBtn.addEventListener('click',movePage)

        
    </script>
{% endif %}
</body>
</html>
